// Botnology101 Home Page Script

// ========== Utility ==========
function $(id) { return document.getElementById(id); }
function q(sel) { return document.querySelector(sel); }
function qa(sel) { return Array.from(document.querySelectorAll(sel)); }
function escapeHTML(str) { return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function show(el) { el && (el.style.display = ""); }
function hide(el) { el && (el.style.display = "none"); }
function setText(id, txt) { const el=$(id); if(el) el.textContent=txt; }
function badgeClass(plan) {
  plan = (plan||"").toLowerCase();
  if (plan==="masters") return "badge gold";
  if (plan==="bachelors") return "badge";
  return "badge";
}

// ========== State ==========
let user = { name: "Guest", plan: "associates", student_id: "BN-‚Ä¶", token: null };

// ========== API Health ==========
async function checkHealth() {
  try {
    const res = await fetch("/api/health");
    const data = await res.json();
    setText("healthLine", "API: " + (data.status === "ok" ? "online" : "offline"));
    $("healthDot").style.background = data.status === "ok" ? "#10b981" : "#f43f5e";
  } catch {
    setText("healthLine", "API: offline");
    $("healthDot").style.background = "#f43f5e";
  }
}
checkHealth();

// ========== Whoami & Plan ==========
async function fetchMe() {
  try {
    const res = await fetch("/api/me", { headers: user.token ? { Authorization: "Bearer " + user.token } : {} });
    const data = await res.json();
    if (data.logged_in) {
      user = { ...user, ...data };
      setText("whoami", `${user.name} ‚Ä¢ ${user.student_id}`);
      setText("planBadge", (user.plan||"ASSOCIATES").toUpperCase());
      $("planBadge").className = badgeClass(user.plan);
    }
  } catch {}
}
fetchMe();

// ========== Subscription ==========
async function fetchSubscription() {
  try {
    const res = await fetch("/api/subscription", { headers: user.token ? { Authorization: "Bearer " + user.token } : {} });
    const data = await res.json();
    setText("subBadge", "SUBSCRIPTION: " + (data.status||"NONE").toUpperCase());
  } catch {}
}
fetchSubscription();

// ========== Auth Modal ==========
if ($("openAuth")) $("openAuth").onclick = () => show($("authModal"));
if ($("closeAuth")) $("closeAuth").onclick = () => hide($("authModal"));
if ($("doAuth")) $("doAuth").onclick = async () => {
  const name = $("authName").value.trim() || "Student";
  const email = $("authEmail").value.trim();
  const plan = $("authPlan").value;
  if (!email || !email.includes("@")) {
    alert("Please enter a valid email.");
    return;
  }
  try {
    const res = await fetch("/api/auth", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, email, plan })
    });
    const data = await res.json();
    if (data.token) {
      user = { ...user, ...data, token: data.token };
      hide($("authModal"));
      fetchMe();
      fetchSubscription();
      showToast("Signed in!", `Welcome, ${user.name}`);
    } else {
      alert("Sign in failed.");
    }
  } catch {
    alert("Sign in failed.");
  }
};

// ========== Theme Toggle ==========
if ($("themeToggle")) $("themeToggle").onclick = () => {
  document.body.classList.toggle("yeti");
};

// ========== Chat Panel ==========
if ($("startNewChat")) $("startNewChat").onclick = () => {
  const chat = q(".chat");
  if (chat) {
    chat.style.display = "";
    $("chatInput") && ($("chatInput").value = "");
    $("messages") && ( $("messages").innerHTML = "" );
  }
};
if ($("resumeBtn")) $("resumeBtn").onclick = () => {
  const chat = q(".chat");
  if (chat) chat.style.display = "";
};
if ($("sendBtn")) $("sendBtn").onclick = async () => {
  const msg = $("chatInput").value.trim();
  if (!msg) return;
  $("chatInput").value = "";
  const messages = $("messages");
  if (messages) {
    messages.innerHTML += `<div class="message user">${escapeHTML(msg)}</div>`;
    messages.scrollTop = messages.scrollHeight;
  }
  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json", ...(user.token ? { Authorization: "Bearer " + user.token } : {}) },
      body: JSON.stringify({ message: msg, plan: user.plan })
    });
    const data = await res.json();
    if (messages) {
      messages.innerHTML += `<div class="message assistant">${escapeHTML(data.reply||"(No reply)")}</div>`;
      messages.scrollTop = messages.scrollHeight;
    }
  } catch {
    if (messages) {
      messages.innerHTML += `<div class="message assistant">(Error: could not reach API)</div>`;
      messages.scrollTop = messages.scrollHeight;
    }
  }
};

// ========== Badge Modal ==========
if ($("openBadge")) $("openBadge").onclick = () => show($("badgeModal"));
if ($("closeBadge")) $("closeBadge").onclick = () => hide($("badgeModal"));
if ($("badgeFile")) $("badgeFile").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => $("cropImg").src = ev.target.result;
  reader.readAsDataURL(file);
};

// ========== Import/Export ==========
if ($("exportBtn")) $("exportBtn").onclick = () => {
  const messages = $("messages");
  if (!messages) return;
  const data = { chat: messages.innerText || "" };
  const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "botnology-chat.json";
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
};
if ($("importBtn")) $("importBtn").onclick = () => show($("importModal"));
if ($("closeImport")) $("closeImport").onclick = () => hide($("importModal"));
if ($("importButton")) $("importButton").onclick = () => $("importFile").click();
if ($("doImport")) $("doImport").onclick = () => {
  const file = $("importFile").files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (data.chat && $("messages")) $("messages").innerText = data.chat;
      hide($("importModal"));
      showToast("Import successful", "Chat imported.");
    } catch {
      alert("Invalid file.");
    }
  };
  reader.readAsText(file);
};

// ========== Toast ==========
function showToast(title, msg) {
  setText("toastTitle", title);
  setText("toastMsg", msg);
  const toast = $("toast");
  if (!toast) return;
  toast.style.display = "";
  setTimeout(() => { toast.style.display = "none"; }, 2500);
}

// ========== Misc Buttons ==========
if ($("coffeeBtn")) $("coffeeBtn").onclick = () => showToast("‚òïÔ∏è Coffee Break", "Take a quick break and come back refreshed!");
if ($("penBtn")) $("penBtn").onclick = () => showToast("üñäÔ∏è Pen Mode", "Ready for note-taking!");
